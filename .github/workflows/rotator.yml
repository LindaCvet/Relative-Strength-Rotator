name: Relative Strength Rotator (5x/day)

on:
  schedule:
    # 07:00, 11:00, 15:00, 19:00, 23:00 Rīga (vasarā UTC+3 → zemāk UTC)
    - cron: "0 4 * * *"
    - cron: "0 8 * * *"
    - cron: "0 12 * * *"
    - cron: "0 16 * * *"
    - cron: "0 20 * * *"
  workflow_dispatch: {}

permissions:
  contents: write   # lai varam komitēt last_top.json izmaiņas

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run rotator
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_IDS: ${{ secrets.TELEGRAM_CHAT_IDS }}
          WATCHLIST_MODE: TOP100
          MIN_24H_VOLUME_USD: "50000000"
          MIN_24H_PCT: "3.0"
          MA_PERIOD: "20"
          RSI_THRESHOLD: "55"
          ATR_PCT_MIN: "1.5"
          TIMEFRAME: "1h"
          TOP_N: "5"
          LANGUAGE: "LV"
          SHORT_FORMAT: "true"
          ADVICE_ENABLED: "true"   # ja negribi entry/SL/TP, ieliec "false"
        run: |
          python main.py

      # ───────────────────────────────────────────────────────────
      # Debug Telegram ping (palīdz pārbaudīt TOKEN/CHAT_ID)
      # ───────────────────────────────────────────────────────────
           - name: Debug Telegram ping (safe)
        if: always()
        shell: bash
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_IDS: ${{ secrets.TELEGRAM_CHAT_IDS }}
        run: |
          set -euo pipefail
          if [[ -z "${TELEGRAM_BOT_TOKEN:-}" || -z "${TELEGRAM_CHAT_IDS:-}" ]]; then
            echo "TELEGRAM_BOT_TOKEN vai TELEGRAM_CHAT_IDS nav iestatīti."; exit 1
          fi
          # sadalām pēc komatiem, ignorējam atstarpes
          for CID in $(printf '%s' "$TELEGRAM_CHAT_IDS" | tr ',' ' '); do
            CID_TRIMMED="$(echo "$CID" | xargs)"
            echo "Pinging chat_id=$CID_TRIMMED"
            # drukājam arī Telegram atbildi, lai redzētu kļūdas (chat not found utt.)
            curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="$CID_TRIMMED" \
              -d text="Rotator debug ping $(date -u +%H:%M UTC)" \
              -o /dev/stdout
            echo
            sleep 1
          done

